<!DOCTYPE html>
<html>
<head>
    <title>01.01 - Basic scene</title>
    <script src="libs/three.js"></script>
    <script src="libs/jquery.js"></script>
    <script src="libs/dat.gui.min.js"></script>
    <script src="libs/stats.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/ColladaLoader.js"></script>
    <script src="physi.js"></script>
    <script src="physijs_worker.js"></script>
    <script src="ammo.js"></script>
    <script src="mapBuilder.js"></script>
    <script src="fires.js"></script>
    <script src="trafficControl.js"></script>
    <script src="lights.js"></script>
    <script src="carMovements.js"></script>
    <script src="userActions.js"></script>
    <style>
        body {
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<script>
    // global variables
    var renderer;
    var scene;
    var camera;
    var spotLight;
    var cameraControl;
    var ambientLight;
    var map;
    var object ,cube, line;
    var way = [];
    var way2 = [];
    var pos = 0;
    var obj;
    SPEED=1;
    ROTATION=0;
    vehicles=[];
    var nb = 1;
    var largeurRoute = 20;
    var geom;
    var detailAngle = 10;
    var ways = [], way1 = [], way2 = [], way3 = [], way4 = [], way5 = [], way6 = [];
    var dots = [];
    var collidableMeshList = [];
    var selectedObject, movingCube;
    var dist1, dist2;
    var fires;
    var timerSeq, timer11, timer12, timer21, timer22;
    var penalites = [];

var timeLeftInterval;
   /**
     * Initializes the scene, camera and objects. Called when the window is
     * loaded by using window.onload (see below)
     */
    function init() {

        // create a scene, that will hold all our elements such as objects, cameras and lights.
        scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3(0,-100,0));

        ways = [[], [], [], []];

        fires = [];

        fires["player1"] = [];
        fires["player2"] = [];

        penalites["player1"] = [];
        penalites["player1"]["Orange"]=0;
        penalites["player1"]["Red"]=0;
        penalites["player2"] = [];
        penalites["player2"]["Orange"]=0;
        penalites["player2"]["Red"]=0;


        var material = Physijs.createMaterial(new THREE.MeshLambertMaterial({color: 0xbe7e0b,side : THREE.DoubleSide}));
        geom = new THREE.Geometry(); 
        map_custom1(0, 1);
        geom.computeFaceNormals();
        map = new Physijs.BoxMesh( geom, material);
        map.position.z = 0;
        map.rotation.x = Math.PI * -0.5;
        scene.add(map);


        var material = Physijs.createMaterial(new THREE.MeshLambertMaterial({color: 0x0b89be,side : THREE.DoubleSide}));
        geom = new THREE.Geometry(); 
        map_custom2(2, 3);
        geom.computeFaceNormals();
        map = new Physijs.BoxMesh( geom, material);
        map.position.z = 0;
        map.rotation.x = Math.PI * -0.5;
        map.position.y=1;
        scene.add(map);

        
        addLights();

        ground_material = Physijs.createMaterial(
            new THREE.MeshPhongMaterial({opacity:0,transparent:true}),
            .9,
            .6
            );

        ground = new Physijs.BoxMesh(
            new THREE.BoxGeometry(1000,1,1000),
            ground_material
            )

        ground.receiveShadow = true;
        ground.position.y = 0;

        scene.add(ground);




////////////////////////////FIRE

loadFires();


////////////////////////////FIRE

fires["player1"].push({pos:59, state:""});
fires["player1"].push({pos:212, state:""});
fires["player1"].push({pos:302, state:""});
fires["player1"].push({pos:475, state:""});
fires["player1"].push({pos:568, state:""});
fires["player1"].push({pos:618, state:""});

fires["player2"].push({pos:79, state:""});
fires["player2"].push({pos:119, state:""});
fires["player2"].push({pos:149, state:""});
fires["player2"].push({pos:621, state:""});
fires["player2"].push({pos:727, state:""});
fires["player2"].push({pos:29, state:""});


addCar("mclaren",0);


        // create a camera, which defines where we're looking at.
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

        // create a render, sets the background color and the size
        renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0x000000, 1.0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;

        // position and point the camera to the center of the scene
        camera.position.x = 270;
        camera.position.y = 140;
        camera.position.z = 344;
        
        cameraControl = new THREE.OrbitControls(camera);

        // setup the control of color, opacity, camera speed...
        control = new function(){
            this.rotationSpeed = 0;
            this.opacity = 0.6;
            this.color = 0xb12929;
        };


        // add extra
        addControlGui(control);
        addStatsObject();

        // add the output of the renderer to the html element
        document.body.appendChild(renderer.domElement);

        render();

    }


    function addPlayer(idWay){

        var obj = scene.getObjectByName('mclaren');
        var obj2 = obj.clone();
        vname='player'+nb;
        nb++;
        obj2.scale.x=.9;
        obj2.scale.y=.9;
        obj2.scale.z=.9;
        obj2.name=vname;
        obj2.speed = 0;
        obj2.pos=0;
        obj2.dist=0;
        obj2.position.x = ways[idWay][0].x;
        // obj2.position.y = ways[2][pos].y;
        obj2.position.z = ways[idWay][0].z;
        obj2.rotation.y = Math.PI*.5;
        vehicles.push({way:idWay,name:vname});
        scene.add(obj2);
        // collidableMeshList.push(obj2);
        // selectedObject=obj2;
    }


    function addCar(name,pos){
    //mclaren
    //touareg
        loader = new THREE.ColladaLoader();
        loader.load('assets/models/mclaren/mclaren.dae',function colladaReady( collada ){
            var obj = collada.scene;
            // skin = collada.skins [ 0 ];
            obj.scale.x = obj.scale.y = obj.scale.z = .01;
            // obj.scale.x = obj.scale.y = obj.scale.z = .005;//touareg

            //i'll add code here later for extra bump mapping on webgl versions

            //usefull for shadows on webgl version
            // daemesh = player.children[0];
            obj.castShadow = true;
            obj.receiveShadow = true;
            // obj.rotation.y = Math.PI * 1;

            obj.position.x = ways[2][pos].x;
            obj.position.y = ways[2][pos].y-7.2;
            obj.position.z = ways[2][pos].z;
            obj.pos=pos;
            obj.name = name;

            scene.add( obj );
            // vehicles.push({way:0,name:name});
        });

    }




    
   


    function addControlGui(controlObject){
        var gui = new dat.GUI();
        gui.add(controlObject, 'rotationSpeed',-0.01,0.01);
        gui.add(controlObject,'opacity', 0.1,1);
        gui.addColor(controlObject, 'color');
    }


    function addStatsObject(){
        stats = new Stats();
        stats.setMode(0);

        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '0px';
        stats.domElement.style.top = '0px';

        document.body.appendChild(stats.domElement);

    }

    /**
     * Called when the scene needs to be rendered. Delegates to requestAnimationFrame
     * for future renders
     */
    function render() {


        camera.lookAt(scene.position);

        // FPS update 
        stats.update();
        cameraControl.update();

        // render using requestAnimationFrame
        requestAnimationFrame(render);
        renderer.render(scene, camera);
        // object.material.color = new THREE.Color(parseInt(getRandomColor()));
        scene.simulate();  
        for(i=0;i<vehicles.length;i++){
            if(scene.getObjectByName(vehicles[i].name).speed != 0) {
                go(vehicles[i].way,vehicles[i].name);
            }
        }
    }

function getRandomColor() {
    var letters = '0123456789ABCDEF'.split('');
    var color = '0x';
    for (var i = 0; i < 6; i++ ) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
    /**
     * Function handles the resize event. This make sure the camera and the renderer
     * are updated at the correct moment.
     */
    function handleResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    window.onkeydown = checkKey;

    var engineOnP1, engineOffP1, engineOnP2, engineOffP2;

    // calls the init function when the window is done loading.
    window.onload = init;
    // calls the handleResize function when the window is resized
    window.addEventListener('resize', handleResize, false);

    
function launchGame(){
    $("#game").css("z-index",-1);
    addPlayer(0);addPlayer(2);
    initFeux();timerSeq = setInterval(function(){switchFiresP1();},16000);

    setTimeLeft("player1");

}



function setTimeLeft(player){
    player2 = "player2";
    if(player == "player2"){
        player2 = "player1"
    }

    $("#"+player).attr("class","switch");
    $("#"+player2).attr("class","avoid");

    $("#"+player2+"_attack").text(0);

    setTimeout(function(){
        setTimeLeft(player2);
    },5000);

    var timeLeft = 5;
    $("#"+player+"_attack").text(timeLeft);
    clearInterval(timeLeftInterval);
    
    timeLeftInterval = setInterval(function(){
        timeLeft --;
        $("#"+player+"_attack").text(timeLeft);
        if (timeLeft == 0) {
            clearInterval(timeLeftInterval);
        }
    },1000);    
}

</script>
<style type="text/css">
    body{
        font-family: verdana;
    }
    .switch{
        background-color: green;
        opacity: .7;
        width: 250px;
        height: 300px;
        border-radius: 25px;
        font-family: verdana;
        padding: 10px;
        
    }

    .avoid{
        background-color: red;
        opacity: .7;
        width: 250px;
        height: 300px;
        border-radius: 25px;
        font-family: verdana;
        padding: 10px;
        
    }

    .text{
        padding: 10px;
    }

    .middle{
        font-size: 50pt;
    }

    .left{
        left:50px;
    }

    .right{
        right:50px;
    }

</style>
<body>
<div onclick="launchGame();" id="game" style="cursor:pointer;color:white;background-color:grey;z-index:15;position:absolute;width:100%;height:100%;opacity:.8">
<p style="border:5px white solid;color:white;font-size:75px;margin-left:37%;margin-top:15%;width:500px;font-family:verdana">START GAME</p>
</div>


<div id="player1" class="switch" style="color:white;z-index:10;position:absolute;top:180px;left:50px;"><b>Player 1 : Z / S</b></div>
<div class="text left" style="color:white;z-index:10;position:absolute;top:220px">Vitesse : <span id="player1_speed" >0</span> km/h</div>
<div class="text left" style="color:white;z-index:10;position:absolute;top:240px">Distance parcourue : <span id="player1_dist" ></span></div>
<div class="text left" style="color:white;z-index:10;position:absolute;top:260px">Feux oranges : <span id="player1_Orange" ></span></div>
<div class="text left" style="color:white;z-index:10;position:absolute;top:280px">Feux rouges : <span id="player1_Red" ></span></div>
<div id="player1_attack" class="middle" style="color:white;z-index:10;position:absolute;top:350px;left:155px"></div>

<div id="player2" class="avoid" style="color:white;z-index:10;position:absolute;top:180px;right:50px;"><b>Player 2 : O / L</b></div>
<div class="text right" style="color:white;z-index:10;position:absolute;top:220px">Vitesse : <span id="player2_speed" >0</span> km/h</div>
<div class="text right" style="color:white;z-index:10;position:absolute;top:240px">Distance parcourue : <span id="player2_dist" ></span></div>
<div class="text right" style="color:white;z-index:10;position:absolute;top:260px">Feux oranges : <span id="player2_Orange" ></span></div>
<div class="text right" style="color:white;z-index:10;position:absolute;top:280px">Feux rouges : <span id="player2_Red" ></span></div>
<div id="player2_attack" class="middle" style="color:white;z-index:10;position:absolute;top:350px;right:155px"></div>


</body>



</html>